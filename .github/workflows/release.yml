name: Create Release on Merge to Master

on  :
    push:
        branches:
            - master

jobs:
    build     :
        name   : Build The Project
        runs-on: ubuntu-latest

        steps  :
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Set up NodeJS
                uses: actions/setup-node@v4
                with:
                    node-version: 22
                    cache       : 'yarn'

            -   name: Install dependencies
                run : yarn install --frozen-lockfile

            -   name: Run build
                run : yarn build

            -   name : Create ZIP archive
                run  : |
                    cd dist
                    zip -r ../frontend-build.zip .
                shell: bash

            -   name: Upload build artifact
                uses: actions/upload-artifact@v4
                with:
                    name: frontend-build
                    path: frontend-build.zip

    versioning:
        name   : Determine Version & Generate Changelog
        runs-on: ubuntu-latest
        needs  : build

        permissions:
            contents: write

        steps  :
            -   name: Checkout repository
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0  # DON'T REMOVE: Required for semantic-release to analyze all commits

            -   name: Set up NodeJS
                uses: actions/setup-node@v4
                with:
                    node-version: 22
                    cache       : 'yarn'

            -   name: Install dependencies
                run : yarn install --frozen-lockfile

            -   name: Release with Semantic Versioning
                env :
                    GITHUB_TOKEN: ${{ secrets.PAT }}
                run : npx semantic-release

    publish   :
        name   : Publish Release
        runs-on: ubuntu-latest
        needs  : versioning

        steps  :
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Download build artifact
                uses: actions/download-artifact@v4
                with:
                    name: frontend-build

            -   name: Upload ZIP to GitHub Release
                uses: softprops/action-gh-release@v2
                with:
                    files: frontend-build.zip
                env :
                    GITHUB_TOKEN: ${{ secrets.PAT }}
